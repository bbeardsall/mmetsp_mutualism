
### LINKS ###
MMETSP project: https://www.imicrobe.us/#/projects/104


Guillardia theta CCMP 2712 - MMETSP0046
MMETSP1006-Emiliania-huxleyi


Install kraken2 version 2.1.1 with
$ conda install kraken2=2.1.1

create environment:
conda create -n readAssignment kraken2=2.1.1

build library with bacteria, archaea, viral, univec_core, plant, protozoa
$ kraken2-build --download-library bacteria --db bacArcVirVecPltPro_db
$ kraken2-build --download-library archaea --db bacArcVirVecPltPro_db
$ kraken2-build --download-library viral --db bacArcVirVecPltPro_db
$ kraken2-build --download-library UniVec_Core --db bacArcVirVecPltPro_db
$ kraken2-build --download-library plant --db bacArcVirVecPltPro_db
$ kraken2-build --download-library protozoa --db bacArcVirVecPltPro_db


Cancelled.

Taxonomy:
$ kraken2-build --download-taxonomy --db bacArcVirVec_EHux_db

Added kraken taxid (|kraken:taxid|280463) to sequence IDs of E. hux genome fasta
Script: addKrakenTaxid.ipynb

Add to library
kraken2-build --add-to-library eHux_krakenTaxid.fasta --db bacArcVirVec_EHux_db

Copy existing bacteria, archaea, plasmid, viral, UniVec_Core libraries to new folder (bacArcVirVec_EHux_db).
/mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db/library

Build db with 32 cores.
kraken2-build --build --threads 32 --db bacArcVirVec_EHux_db
Started around 11:50 on Feb 26.
Took 4 h 32 min for 100785 sequences, 92126775557 bp

Classify eHux MMETSP reads.
$ kraken2 --use-names --threads 32 --db /mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db --report eHux_customdb --paired MMETSP1006-Emiliania-huxleyi-374.1.fastq MMETSP1006-Emiliania-huxleyi-374.2.fastq > eHux_customdb.kraken
start at 5:15
/mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db


9. March. 2020
All genbank genome ftp paths from: https://ftp.ncbi.nih.gov/genomes/genbank/assembly_summary_genbank.txt
Trying to get ftp paths for all MMETSP species genomes.

Example snakefile from Dr. Irwin:
https://hackmd.io/SU2NB89JRu6fRPtSFizEEA?view 

Download all available MMETSP genomes.
wget -i genome_ftp_paths.txt -P ./genomes/

Start jupyter server.
jupyter lab --no-browser --port=8080
ssh -N -L 8080:localhost:8080 bbeardsall@bio2.mmab.ca

Download taxonomy and databases.
kraken2-build --download-taxonomy --db mmetsp_genome_db && kraken2-build --download-library UniVec_Core --db mmetsp_genome_db && kraken2-build --download-library viral --db mmetsp_genome_db
kraken2-build --download-library archaea --db mmetsp_genome_db && kraken2-build --download-library bacteria --db mmetsp_genome_db

Took too long to mask bacteria library, so copied from previous standard database.
Added sequences to database with snakemake script.

Build database (started 2:33 PM, March 10):
$   kraken2-build --build --db mmetsp_genome_db --threads 32

457644 sequences, 94267203205 bp
Database files completed. [4h38m23.583s]
Database construction complete. [Total: 4h50m33.923s]


kraken2 --use-names --threads 32 --db data/mmetsp_genome_db --report 2004 --paired data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq > results/2004.kraken


kraken2 --use-names --threads 32 --db data/mmetsp_genome_db --report results/2004 --paired data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq > results/2004.kraken


11. March 2021
2234: 93.5% target, 0.7% bacteria, 6% unclassified
Marinobacter = 1600,
Pseudomonas putida = 21

2004 Aureococcus anophagefferens:
88.32% target, 0.38% bacteria, 10.8% unclassified
11742 Streptomyces

2282 
92.5% Vitrella brassicaformis CCMP3155, 0.07% bacteria, 7.3% unclassified
447 Halieaceae bacterium IMCC3088
109 Halioglobus
432 Oceanospirillales

2502
96.09% Pycnococcus provasolii, 2.7% unclassified, 0.09% bacteria
6202 Marinobacter
4 Glaciecola

From antartica:
 93% Euplotes focardii, 6.4% unclassified, 0.08% bacteria
 Paraglaciecola psychrophila (arctic)

23. March. 2021
Want to increase size of reference database to include all matching MMETSP and genbank
at a (class?) level, not just matching species. 

24. March. 2021
Made a world map showing the locations of all MMETSP samples.
Issues with MMETSP metadata - multiple latitude/longitudes for same sample.
For duplicate latitudes, first entry correct. For duplicate longitudes, second entry (>0) correct. Verified by biosample ID.
Plot on map: https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html

install dependecy for r spatial: sudo apt install libudunits2-dev
sudo apt install libgdal-dev
Also install R package "rgeos".

Want to turn genbank taxid into kingdom, phylum, class, etc. to match MMETSP
Using package taxonomizr.
Moved taxonomizr intermediate files to data/

27. March 2021
Try joining genbank genome df with taxonomy df.
Inner join taking forever ...
Too slow with tibbles. Try using data.table. Works, but removing duplicate taxids made dplyr joinin
fast enough.

28. March. 2021
For each MMETSP speices, get matching genbank genome at species level, genus if no species,
family if no genus, ...

results/krakenOutputs/2475-MMETSP0053-Prorocentrum-minimum-CCMP1329.kraken


7. April 2021
Good snakemake tutorial: https://old.research.jetbrains.org/files/material/5ec245b4e907c.pdf 
also https://taylorreiter.github.io/2020-02-03-How-to-use-snakemake-checkpoints-to-extract-files-from-an-archive/
FINALLY fixed checkpoint issue. Instead of trying to split {mmmetspName}-{fullSpeciesName}, just used {fullSpeciesName}.
Each kraken instance uses ~ 31.2 gb with current database.

257817.0 Total
200000 available for use
18.9% usage = 48,727.413 Mb each ~ 50000 Mb each
Run with snakemake --cores 32 --resources mem_mb=200000

Since some MMETSP have a "_2" prefix, changed file delimiter to "_-_".

19. April. 2020
Reads only 50 bp long (paired).
Bracken use tutorial: https://genomics.sschmeier.com/ngs-taxonomic-investigation/index.html 


./bracken-build -d ${KRAKEN_DB} -t ${THREADS} -k ${KMER_LEN} -l ${READ_LEN} -x ${KRAKEN_INSTALLATION}
bracken-build -d data/mmetsp_genome_db -t 32 -k 35 -l 50

Built bracken database (didn't take long).

20. April. 2021
Try to classify with bracken.

bracken -d data/mmetsp_genome_db -i results/krakenReports/1682_-_MMETSP0043_-_MMETSP0043-2-Hemiselmis-andersenii-CCMP644.report -o results/brackenTest/Hemiselmis-andersenii.bracken -r 50

Visualize with Krona.
conda install -c bioconda krona

columns of bracken to use:
1, 2, 7
cat Hemiselmis-andersenii.bracken | cut -f 1,2,6 > Hemiselmis-andersenii.bracken.krona
ktImportTaxonomy Hemiselmis-andersenii.bracken.krona

Added bracken rule to snakefile.


results/kronaGraph/1699_-_MMETSP0046_-_MMETSP0046_2-Guillardia-theta-CCMP2712.kraken.krona.html


Krona doesn't work with bracken.
Remove use-names flag from kraken rule.

26. April 2021
Installed krakenuniq via conda

krakenuniq-download --db krakenUniq_mmetsp_genome_db/ taxonomy
krakenuniq-download -db krakenUniq_mmetsp_genome_db/ --threads 10 --dust refseq/bacteria refseq/archaea

27. April 2021

Create mapping file for krakenUniq database building.
Style described in readme: https://github.com/fbreitwieser/krakenuniq 
seqId   taxid   name

Or? Try just adding to library using krakenuniq-build --add-to-library $FILE --db $DBNAME

krakenuniq-build --add-to-library taxIdAppendedGenomes/taxIdAppended_GCA_000002455.1_ASM245v1_genomic.fasta --db krakenUniq_mmetsp_genome_db

This works, but doesn't dust mask or add .map file.

Krakenuniq dust settings:
dustmasker -infmt fasta -in $fasta_file -level 20 -outfmt fasta | sed '/^>/! s/[^AGCT]/N/g' > $dustmasked_file.tmp && mv $dustmasked_file.tmp $dustmasked_file

snakemake data/genome_maps/GCA_000002455.1_ASM245v1_genomic-dustmasked.fna.map  -n


