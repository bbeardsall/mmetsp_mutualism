
### LINKS ###
MMETSP project: https://www.imicrobe.us/#/projects/104


Guillardia theta CCMP 2712 - MMETSP0046
MMETSP1006-Emiliania-huxleyi


Install kraken2 version 2.1.1 with
$ conda install kraken2=2.1.1

create environment:
conda create -n readAssignment kraken2=2.1.1

build library with bacteria, archaea, viral, univec_core, plant, protozoa
$ kraken2-build --download-library bacteria --db bacArcVirVecPltPro_db
$ kraken2-build --download-library archaea --db bacArcVirVecPltPro_db
$ kraken2-build --download-library viral --db bacArcVirVecPltPro_db
$ kraken2-build --download-library UniVec_Core --db bacArcVirVecPltPro_db
$ kraken2-build --download-library plant --db bacArcVirVecPltPro_db
$ kraken2-build --download-library protozoa --db bacArcVirVecPltPro_db


Cancelled.

Taxonomy:
$ kraken2-build --download-taxonomy --db bacArcVirVec_EHux_db

Added kraken taxid (|kraken:taxid|280463) to sequence IDs of E. hux genome fasta
Script: addKrakenTaxid.ipynb

Add to library
kraken2-build --add-to-library eHux_krakenTaxid.fasta --db bacArcVirVec_EHux_db

Copy existing bacteria, archaea, plasmid, viral, UniVec_Core libraries to new folder (bacArcVirVec_EHux_db).
/mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db/library

Build db with 32 cores.
kraken2-build --build --threads 32 --db bacArcVirVec_EHux_db
Started around 11:50 on Feb 26.
Took 4 h 32 min for 100785 sequences, 92126775557 bp

Classify eHux MMETSP reads.
$ kraken2 --use-names --threads 32 --db /mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db --report eHux_customdb --paired MMETSP1006-Emiliania-huxleyi-374.1.fastq MMETSP1006-Emiliania-huxleyi-374.2.fastq > eHux_customdb.kraken
start at 5:15
/mnt/D2/bbeardsall/krakenFiles/bacArcVirVec_EHux_db


9. March. 2020
All genbank genome ftp paths from: https://ftp.ncbi.nih.gov/genomes/genbank/assembly_summary_genbank.txt
Trying to get ftp paths for all MMETSP species genomes.

Example snakefile from Dr. Irwin:
https://hackmd.io/SU2NB89JRu6fRPtSFizEEA?view 

Download all available MMETSP genomes.
wget -i genome_ftp_paths.txt -P ./genomes/

Start jupyter server.
jupyter lab --no-browser --port=8080
ssh -N -L 8080:localhost:8080 bbeardsall@bio2.mmab.ca

Download taxonomy and databases.
kraken2-build --download-taxonomy --db mmetsp_genome_db && kraken2-build --download-library UniVec_Core --db mmetsp_genome_db && kraken2-build --download-library viral --db mmetsp_genome_db
kraken2-build --download-library archaea --db mmetsp_genome_db && kraken2-build --download-library bacteria --db mmetsp_genome_db

Took too long to mask bacteria library, so copied from previous standard database.
Added sequences to database with snakemake script.

Build database (started 2:33 PM, March 10):
$   kraken2-build --build --db mmetsp_genome_db --threads 32

457644 sequences, 94267203205 bp
Database files completed. [4h38m23.583s]
Database construction complete. [Total: 4h50m33.923s]


kraken2 --use-names --threads 32 --db data/mmetsp_genome_db --report 2004 --paired data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq > results/2004.kraken


kraken2 --use-names --threads 32 --db data/mmetsp_genome_db --report results/2004 --paired data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq data/MMETSP_fastq/2004/MMETSP0914-Aureococcus-anophagefferens-CCMP1850.1.fastq > results/2004.kraken


11. March 2021
2234: 93.5% target, 0.7% bacteria, 6% unclassified
Marinobacter = 1600,
Pseudomonas putida = 21

2004 Aureococcus anophagefferens:
88.32% target, 0.38% bacteria, 10.8% unclassified
11742 Streptomyces

2282 
92.5% Vitrella brassicaformis CCMP3155, 0.07% bacteria, 7.3% unclassified
447 Halieaceae bacterium IMCC3088
109 Halioglobus
432 Oceanospirillales

2502
96.09% Pycnococcus provasolii, 2.7% unclassified, 0.09% bacteria
6202 Marinobacter
4 Glaciecola

From antartica:
 93% Euplotes focardii, 6.4% unclassified, 0.08% bacteria
 Paraglaciecola psychrophila (arctic)

23. March. 2021
Want to increase size of reference database to include all matching MMETSP and genbank
at a (class?) level, not just matching species. 

24. March. 2021
Made a world map showing the locations of all MMETSP samples.
Issues with MMETSP metadata - multiple latitude/longitudes for same sample.
For duplicate latitudes, first entry correct. For duplicate longitudes, second entry (>0) correct. Verified by biosample ID.
Plot on map: https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html

install dependecy for r spatial: sudo apt install libudunits2-dev
sudo apt install libgdal-dev
Also install R package "rgeos".

Want to turn genbank taxid into kingdom, phylum, class, etc. to match MMETSP
Using package taxonomizr.
Moved taxonomizr intermediate files to data/